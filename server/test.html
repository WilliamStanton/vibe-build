<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vibe Build â€” WS Test</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: monospace;
      background: #0f0f0f;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 16px;
      gap: 12px;
    }

    h1 { font-size: 1rem; color: #888; letter-spacing: 0.05em; }

    #status {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 4px;
      display: inline-block;
      background: #333;
      color: #888;
    }
    #status.connected { background: #1a3a1a; color: #4caf50; }
    #status.error     { background: #3a1a1a; color: #f44336; }

    #log {
      flex: 1;
      overflow-y: auto;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      padding: 12px;
      font-size: 0.8rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .row { display: flex; gap: 8px; }

    #position {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
      color: #888;
    }
    #position label { color: #666; }
    #position input {
      width: 64px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #e0e0e0;
      padding: 6px 8px;
      font-family: monospace;
      font-size: 0.8rem;
    }

    #prompt {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #e0e0e0;
      padding: 8px 12px;
      font-family: monospace;
      font-size: 0.85rem;
      outline: none;
    }
    #prompt:focus { border-color: #555; }

    button {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 4px;
      color: #e0e0e0;
      padding: 8px 16px;
      font-family: monospace;
      font-size: 0.85rem;
      cursor: pointer;
    }
    button:hover:not(:disabled) { background: #333; }
    button:disabled { opacity: 0.4; cursor: default; }

    /* log entry colours */
    .msg-thinking { color: #9e9e9e; font-style: italic; }
    .msg-step     { color: #42a5f5; }
    .msg-delta    { color: #e0e0e0; }
    .msg-tool     { color: #ab47bc; }
    .msg-result   { color: #66bb6a; }
    .msg-done     { color: #4caf50; font-weight: bold; }
    .msg-error    { color: #ef5350; font-weight: bold; }
    .msg-sent     { color: #ffa726; }
    .msg-ws       { color: #555; font-style: italic; }
    .msg-auto-result { color: #888; font-style: italic; }
  </style>
</head>
<body>

<h1>vibe-build ws test &nbsp;<span id="status">disconnected</span></h1>

<div id="log"></div>

<div id="position">
  <label>x</label><input id="px" type="number" value="0" />
  <label>y</label><input id="py" type="number" value="64" />
  <label>z</label><input id="pz" type="number" value="0" />
</div>

<div class="row">
  <input id="prompt" type="text" placeholder="Build a stone cottageâ€¦" />
  <button id="sendBtn" disabled>Send</button>
  <button id="clearBtn">Clear</button>
</div>

<script>
  const WS_URL = "ws://localhost:8080";

  const logEl    = document.getElementById("log");
  const statusEl = document.getElementById("status");
  const promptEl = document.getElementById("prompt");
  const sendBtn  = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");
  const pxEl     = document.getElementById("px");
  const pyEl     = document.getElementById("py");
  const pzEl     = document.getElementById("pz");

  let ws = null;
  let busy = false;

  // â”€â”€ Logging â”€â”€

  function log(text, cls = "") {
    const line = document.createElement("div");
    if (cls) line.className = cls;
    line.textContent = text;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  clearBtn.addEventListener("click", () => { logEl.innerHTML = ""; });

  // â”€â”€ WebSocket â”€â”€

  function connect() {
    log(`Connecting to ${WS_URL}â€¦`, "msg-ws");
    ws = new WebSocket(WS_URL);

    ws.addEventListener("open", () => {
      statusEl.textContent = "connected";
      statusEl.className = "connected";
      sendBtn.disabled = false;
      log("Connected.", "msg-ws");
    });

    ws.addEventListener("close", () => {
      statusEl.textContent = "disconnected";
      statusEl.className = "";
      sendBtn.disabled = true;
      busy = false;
      log("Disconnected. Reconnecting in 3sâ€¦", "msg-ws");
      setTimeout(connect, 3000);
    });

    ws.addEventListener("error", () => {
      statusEl.textContent = "error";
      statusEl.className = "error";
      log("WebSocket error.", "msg-error");
    });

    ws.addEventListener("message", (ev) => {
      let msg;
      try { msg = JSON.parse(ev.data); } catch { log(`Raw: ${ev.data}`); return; }

      switch (msg.type) {
        case "thinking":
          log("â³ Thinkingâ€¦", "msg-thinking");
          break;

        case "step":
          log(`\nâ–¶ ${msg.content}`, "msg-step");
          break;

        case "delta":
          // Append delta text inline to last delta node, or create a new one.
          if (logEl.lastChild && logEl.lastChild.classList.contains("msg-delta")) {
            logEl.lastChild.textContent += msg.content;
          } else {
            log(msg.content, "msg-delta");
          }
          logEl.scrollTop = logEl.scrollHeight;
          break;

        case "tool_call": {
          log(`  ðŸ”§ ${msg.name}(${JSON.stringify(msg.args)})`, "msg-tool");
          // Auto-reply with a fake success result so the server isn't blocked.
          const result = JSON.stringify({ success: true, message: "ok (simulated)" });
          ws.send(JSON.stringify({ type: "tool_result", toolCallId: msg.toolCallId, result }));
          log(`  â†© auto-replied: ${result}`, "msg-auto-result");
          break;
        }

        case "done":
          log(`\nâœ“ Done â€” ${msg.toolCount} tool calls, ${msg.completedSteps} steps.`, "msg-done");
          busy = false;
          sendBtn.disabled = false;
          break;

        case "error":
          log(`\nâœ— Error: ${msg.content}`, "msg-error");
          busy = false;
          sendBtn.disabled = false;
          break;

        default:
          log(`[unknown] ${JSON.stringify(msg)}`, "msg-ws");
      }
    });
  }

  // â”€â”€ Send â”€â”€

  function send() {
    const content = promptEl.value.trim();
    if (!content || busy || !ws || ws.readyState !== WebSocket.OPEN) return;

    busy = true;
    sendBtn.disabled = true;

    const payload = {
      type: "prompt",
      content,
      playerPosition: {
        x: Number(pxEl.value) || 0,
        y: Number(pyEl.value) || 64,
        z: Number(pzEl.value) || 0,
      },
    };

    log(`\nâ†’ ${content}`, "msg-sent");
    ws.send(JSON.stringify(payload));
    promptEl.value = "";
  }

  sendBtn.addEventListener("click", send);
  promptEl.addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

  connect();
</script>
</body>
</html>
